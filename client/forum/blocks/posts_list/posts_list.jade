- var postStatuses = '$$ JSON.stringify(N.models.forum.Post.statuses) $$'
- self.users = self.users || {};

//- `self.pagination` may absent if post loaded via `topic.list.by_range`
- var post_counter = self.pagination ? self.pagination.chunk_offset : 0;

//- same as `d % n`, but works with negative numbers correctly
- function mod(d, n) { return (d % n + n) % n; }

//- show bulk operations checkbox
- var bulk_operations_permitted = self.settings.forum_mod_can_delete_topics;

each post, post_idx in self.posts
  - var user = self.users[post.user];
  - var visible = [ postStatuses.DELETED, postStatuses.DELETED_HARD, postStatuses.HB ].indexOf(post.st) === -1;
  - var collapsed = !self.expand && !visible;

  if visible && self.pagination && mod(post_counter, self.pagination.per_page) === 0 && post_counter !== 0
    nav.forum-postlist__paginator
      - var link_params = { section_hid: self.section.hid, topic_hid: self.topic.hid }
      - var page_max    = Math.ceil(self.pagination.total / self.pagination.per_page) || 1;
      - var pgn_params  = { route: 'forum.topic', params: link_params, current: Math.floor(post_counter / self.pagination.per_page) + 1, max: page_max }
      != self.partial('@common.blocks.pagination', pgn_params)

  if !collapsed

    article.forum-post.clearfix(
      id='post#{post._id}'
      class=(post.st === postStatuses.DELETED) ? 'forum-post__m-deleted' : ''
      class=(post.st === postStatuses.DELETED_HARD) ? 'forum-post__m-deleted-hard' : ''
      class=(post.st === postStatuses.HB) ? 'forum-post__m-hb' : ''
      class=(self.own_bookmarks.indexOf(post._id) !== -1) ? 'forum-post__m-bookmarked' : ''
      class=(self.own_votes[post._id] === -1) ? 'forum-post__m-voted-down' : ''
      class=(self.own_votes[post._id] === +1) ? 'forum-post__m-voted-up' : ''
      data-post-hid=post.hid
      data-post-id=post._id
      data-user-hid=user ? user.hid : ''
      itemscope
      itemtype='http://schema.org/WebPageElement'
    )

      footer.forum-post__meta

        //- avatar copy for small screens
        .forum-post__meta-avatar
          if user
            a.forum-post__userpic(href=self.link_to('users.member', { user_hid: user.hid }))
              img.av-l(alt=user.name)&attributes(self.avatar(user, 'md'))
          else if post.legacy_nick
            span.forum-post__userpic
              img.av-l(alt=post.legacy_nick)&attributes(self.avatar(post.legacy_nick, 'md'))
          else
            .av-l

        .forum-post__meta-flex
          .forum-post__meta-content
            .forum-post__meta-author
              if user
                a.forum-post__author._ucard-popover(
                  href=self.link_to('users.member', { user_hid: user.hid })
                  data-user-id=post.user
                ) #{user.name}
              else if post.legacy_nick
                span.forum-post__author=post.legacy_nick

            .forum-post__meta-info
              if post.to && post.to_user && self.users[post.to_user]
                if !post_idx || self.posts[post_idx - 1]._id !== post.to
                  - var _reply_to_params = {};
                  - _reply_to_params.section_hid = post.to_fhid || self.section.hid;
                  - _reply_to_params.topic_hid   = post.to_thid || self.topic.hid;
                  - _reply_to_params.post_hid    = post.to_phid;

                  - var _reply_to_anchor = self.link_to('forum.topic', _reply_to_params);
                  - var _reply_to_user = self.users[post.to_user]

                  a.forum-post__reply-to-link(href=_reply_to_anchor)
                    span.icon.icon-reply-for.icon-space-after
                    img.forum-post__reply-to-avatar(alt=_reply_to_user.name)&attributes(self.avatar(_reply_to_user, 'sm'))
                    = _reply_to_user.nick

              - var _post_anchor = self.link_to('forum.topic', { section_hid: self.section.hid, topic_hid: self.topic.hid, post_hid: post.hid });
              a.forum-post__link(href=_post_anchor)
                != self.timetag(post.ts, 'relative')

        if bulk_operations_permitted
          label.forum-post__select(title=self.t('multiselect_hint'))
            input.forum-post__select-cb(
              type='checkbox'
              data-post-id=post._id
              data-on-change='forum.topic:post_check')
      .forum-post__aside
        if user
          a.forum-post__userpic(href=self.link_to('users.member', { user_hid: user.hid }))
            img.av-l(alt=user.name)&attributes(self.avatar(user, 'md'))
        else if post.legacy_nick
          span.forum-post__userpic
            img.av-l(alt=post.legacy_nick)&attributes(self.avatar(post.legacy_nick, 'md'))
        else
          .av-l
      .forum-post__content
        .forum-post__message.markup !{post.html}

        - var tail = self.partial('@forum.blocks.posts_list.attachments', { post: post, user: user });
        if tail
          .forum-post__tail.markup-tail
            !=tail

        footer.forum-post__controls.clearfix
          ul.forum-post__controls-blk.pull-right

            - var showDropdown = false
            - showDropdown = showDropdown || self.settings.forum_mod_can_edit_posts
            - showDropdown = showDropdown || self.settings.forum_mod_can_delete_topics
            - showDropdown = showDropdown || self.settings.can_see_ip

            if self.runtime.is_member && self.runtime.user_id !== post.user

              if self.settings.can_vote && (self.settings.votes_add_max_time === 0 || new Date(post.ts).getTime() > Date.now() - self.settings.votes_add_max_time * 60 * 60 * 1000)
                li.forum-post__control-item.forum-post__vote-up
                  button.btn.forum-post__action(
                    title=self.t('vote_up')
                    data-on-click='forum.topic.post_vote'
                    data-post-id=post._id
                    data-value=self.own_votes[post._id] === 1 ? '0' : '1'
                  )
                    span.icon.icon-vote-up

                li.forum-post__control-item.forum-post__vote-down
                  button.btn.forum-post__action(
                    title=self.t('vote_down')
                    data-on-click='forum.topic.post_vote'
                    data-post-id=post._id
                    data-value=self.own_votes[post._id] === -1 ? '0' : '-1'
                  )
                    span.icon.icon-vote-down

            li.forum-post__control-item.forum-post__report
              button.btn.forum-post__action(title=self.t('report'))
                span.icon.icon-report

            if self.runtime.is_member

              li.forum-post__control-item.forum-post__bookmark
                button.btn.forum-post__action.forum-post__bookmark-add(
                  data-on-click='forum.topic.post_bookmark'
                  data-post-id=post._id
                  title=self.t('bookmark_add')
                )
                  span.icon.icon-bookmark-empty
                  span.forum-post__bookmarks-count(data-bm-count=post.bookmarks)

                button.btn.forum-post__action.forum-post__bookmark-remove(
                  data-on-click='forum.topic.post_bookmark'
                  data-post-id=post._id
                  data-remove='true'
                  title=self.t('bookmark_remove')
                )
                  span.icon.icon-bookmark
                  span.forum-post__bookmarks-count(data-bm-count=post.bookmarks)


            if (user && user._id === self.runtime.user_id && (self.settings.forum_edit_max_time === 0 || new Date(post.ts).getTime() > Date.now() - self.settings.forum_edit_max_time * 60 * 1000))
              li.forum-post__control-item.forum-post__edit
                button.btn.forum-post__action(
                  data-on-click='forum.topic:post_edit'
                  data-post-id=post._id
                  data-post-hid=post.hid
                )
                  span.icon.icon-edit

              li.forum-post__delete.forum-post__control-item
                button.btn.forum-post__action(
                  data-on-click=self.topic.cache.first_post === post._id ? 'forum.topic.topic_delete' : 'forum.topic.post_delete'
                  data-post-id=post._id
                  data-topic-hid=self.topic.hid
                  title=self.t('delete')
                )
                  span.icon.icon-trash

            if self.settings.forum_can_reply
              li.forum-post__control-item.forum-post__reply
                //- for wide screen
                button.full.btn.forum-post__action(
                  data-on-click='forum.topic:reply'
                  data-post-id=post._id
                  data-post-hid=post.hid
                )
                  span.icon.icon-reply.icon-space-after= self.t('reply')
                //- for narrow screen
                button.short.btn.forum-post__action(
                  data-on-click='forum.topic:reply'
                  data-post-id=post._id
                  data-post-hid=post.hid
                  title=self.t('reply')
                )
                  span.icon.icon-reply

            li.forum-post__control-item.forum-post__votes
              button.btn.forum-post__action(
                data-on-click='common.votes_popover'
                data-votes-popover-placement='left'
                data-votes-popover-for=post._id
                title=self.t('vote_details')
                data-votes-count=(post.votes > 0 ? '+' : '') + post.votes
              )

            if showDropdown

                li.forum-post__control-item.forum-post__mod-menu.dropdown.dropup
                  button.btn.forum-post__action.dropdown-toggle(
                    data-toggle='dropdown'
                    role='button'
                  )
                    span.caret
                  ul.dropdown-menu.dropdown-menu-right(role='menu')

                    if self.settings.can_see_ip
                      li
                        a(href='#'
                          data-post-id=post._id
                          data-on-click='forum.topic.post_show_ip'
                        )= self.t('ip_info')

                    if self.settings.forum_mod_can_edit_posts
                      li
                        a(href='#'
                          data-on-click='forum.topic:post_edit'
                          data-post-id=post._id
                          data-post-hid=post.hid
                          data-as-moderator='true'
                        )= self.t('edit')

                    if self.settings.forum_mod_can_delete_topics
                      li.forum-post__delete
                        a(href='#'
                          data-on-click=self.topic.cache.first_post === post._id ? 'forum.topic.topic_delete' : 'forum.topic.post_delete'
                          data-post-id=post._id
                          data-topic-hid=self.topic.hid
                          data-as-moderator='true'
                        )= self.t('delete')
                      li.forum-post__undelete
                        a(href='#'
                          data-on-click=self.topic.cache.first_post === post._id ? 'forum.topic.topic_undelete' : 'forum.topic.post_undelete'
                          data-post-id=post._id
                          data-topic-hid=self.topic.hid
                        )= self.t('undelete')


  else

    article.forum-post.forum-post__m-collapsed.clearfix(
      id='post#{post._id}'
      class=(post.st === postStatuses.DELETED) ? 'forum-post__m-deleted' : ''
      class=(post.st === postStatuses.DELETED_HARD) ? 'forum-post__m-deleted-hard' : ''
      class=(post.st === postStatuses.HB) ? 'forum-post__m-hb' : ''
      data-post-hid=post.hid
      data-user-hid=user ? user.hid : ''
      itemscope
      itemtype='http://schema.org/WebPageElement'
    )

      footer.forum-post__meta.clearfix
        .forum-post__meta-blk.pull-right
          != self.timetag(post.ts, 'relative')
        .forum-post__meta-blk
          if user
            a.forum-post__author._ucard-popover(
            href=self.link_to('users.member', { user_hid: user.hid })
            data-user-id=post.user
            ) #{user.name}

      .forum-post__content
        case post.st
          when postStatuses.DELETED
           =self.t('del_post_text')
          when postStatuses.DELETED_HARD
           =self.t('del_hard_post_text')
          when postStatuses.HB
           =self.t('hb_post_text')

        if post.del_reason
          .forum-post__del-reason=self.t('del_reason', { text: post.del_reason })
        if post.del_by
          .forum-post__del-by
            =self.t('del_by')
            | 
            - var delUser = self.users[post.del_by]
            a.forum-post__author._ucard-popover(
              href=self.link_to('users.member', { user_hid: delUser.hid })
              data-user-id=post.del_by
            ) #{delUser.name}

      footer.forum-post__controls.clearfix
        ul.forum-post__controls-blk.pull-right
          li.forum-post__control-item
            button.btn.forum-post__action(
              data-on-click='forum.topic.post_expand'
              title=self.t('expand')
              data-post-id=post._id
            )
              span.icon.icon-expand

  - if (visible) { post_counter++; }
