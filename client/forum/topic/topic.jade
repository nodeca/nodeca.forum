- var topicStatuses = '$$ JSON.stringify(N.models.forum.Topic.statuses) $$'

- self.add_raw_data('settings', self.settings)
- self.add_raw_data('section', self.section)
- self.add_raw_data('topic', self.topic)
- self.add_raw_data('subscription', self.subscription)
- self.add_raw_data('pagination', self.pagination)

- var isOpen = (self.topic.st === topicStatuses.OPEN || self.topic.ste === topicStatuses.OPEN);
- var isClosed = (self.topic.st === topicStatuses.CLOSED || self.topic.ste === topicStatuses.CLOSED);

article#content.forum-topic-root(
  data-keymap= {
    'home':   'forum.topic:nav_to_start',
    'end':    'forum.topic:nav_to_end'
  }
  class=isOpen ? 'forum-topic-root__m-open' : ''
  class=isClosed ? 'forum-topic-root__m-closed' : ''
  class=(self.topic.st === topicStatuses.DELETED) ? 'forum-topic-root__m-deleted' : ''
  class=(self.topic.st === topicStatuses.DELETED_HARD) ? 'forum-topic-root__m-deleted-hard' : ''
  class=(self.topic.st === topicStatuses.PINNED) ? 'forum-topic-root__m-pinned' : ''
  data-top-marker= self.posts && self.posts.length > 0 ? self.posts[0].hid : null
  data-bottom-marker= self.posts && self.posts.length > 0 ? self.posts[self.posts.length - 1].hid : null
)
  != self.partial('@common.blocks.breadcrumbs')

  header.page-head
    - var canEdit = (self.runtime.is_member && self.topic.cache.first_user === self.runtime.user_id) &&
    -               (self.settings.forum_edit_max_time === 0 || new Date(self.topic.cache.first_ts).getTime() > Date.now() - self.settings.forum_edit_max_time * 60 * 1000) &&
    -               self.section.is_writable;

    h1.forum-topic-title.page-head__title(itemprop='name')
      .pull-right
        != self.partial('@forum.topic.blocks.toolbar_controls')

      span.forum-topic__closed-mark.icon.icon-closed.icon-space-after(title=self.t('closed'))

      span.forum-topic-title__text= self.topic.title

      if canEdit || self.settings.forum_mod_can_edit_titles
        a.forum-topic-title__edit.icon.icon-edit.icon-space-before(
          href='#'
          title=self.t('edit_title')
          data-on-click='forum.topic.edit_title'
          data-topic-hid=self.topic.hid
          data-as-moderator='#{!canEdit}'
        )

    if self.topic._seo_desc
      p.page-head__descr(itemprop='description')
        | #{self.topic._seo_desc}

    if self.topic.del_by
      - var delUser = self.users[self.topic.del_by] || {}
      .forum-topic-title__meta-deleted
        =self.t('del_by')
        | 
        a(href=self.link_to('users.member', { user_hid: delUser.hid }))=delUser.name
        if self.topic.del_reason
          | 
          =self.t('del_reason', { text: self.topic.del_reason })

  .forum-postlist._affix(
    data-affix-top={
      offset:     500,
      wire_above: 'forum.topic:load_prev',
      throttle:   100
    }
    data-affix-bottom={
      offset:     500,
      wire_below: 'forum.topic:load_next',
      throttle:   100
    }
  )!= self.partial('@forum.blocks.posts_list')

nav.forum-topic__footer-pager
  - var link_params  = { section_hid: self.section.hid, topic_hid: self.topic.hid }
  - var page_current = Math.floor(self.pagination.chunk_offset / self.pagination.per_page) + 1;
  - var page_max     = Math.ceil(self.pagination.total / self.pagination.per_page) || 1;
  - var pgn_params   = { route: 'forum.topic', params: link_params, current: page_current, max: page_max }
  != self.partial('@common.blocks.pagination', pgn_params)
